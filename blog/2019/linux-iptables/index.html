<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>IPTABLES 설정 방법</title>
<meta name="description" content="설정 방법기본 IPTALBE 초기화 방법iptables -Fiptables -Xiptables -P INPUT DROPiptables -P OUTPUT DROPiptables -P FORWARD DROP루프백 허용iptables -A INPUT -i lo -j ACCEPTiptab...">

<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="https://byunghoon82.github.io/blog/2019/linux-iptables/">
<link rel="alternate" type="application/rss+xml" title="Technical Blog" href="https://byunghoon82.github.io/feed.xml" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/">Technical <span>Blog</span></a></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
	<li><a href="/about" title="Home">about</a></li>
	<li><a href="/blog" title="Home">blog</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-rss"></i></a></li>
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">IPTABLES 설정 방법</h1>
      <em class="post-meta">
        <time>Jul 12, 2019</time>
      </em>
    </header>

    <div class="post-content">
      
      <h3 id="설정-방법">설정 방법</h3>

<p>기본 IPTALBE 초기화 방법</p>
<pre><code class="language-bash">iptables -F
iptables -X
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP
</code></pre>

<p>루프백 허용</p>
<pre><code class="language-bash">iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
</code></pre>

<p>외부 &gt; 서버로 22번 포트 허용</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT
</code></pre>

<p>서버 &gt; 외부로 22포트 허용</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --sport 22 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT
</code></pre>

<p>외부 &gt; 서버로 80번 포트 허용</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp  --dport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT
</code></pre>

<p>DNS와의 통신이 허용 되어야만 외부망 접속이 가능</p>
<pre><code class="language-bash">iptables -A INPUT -p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -p udp  --dport 53 -j ACCEPT
</code></pre>

<p>외부 &gt; 서버로 5901번 포트 허용</p>
<pre><code class="language-bash">iptables -A INPUT  -p tcp -m tcp --dport 5901 -j ACCEPT
iptables -A OUTPUT -p tcp -m tcp --sport 5901 -j ACCEPT
</code></pre>

<p>scp를 이용하여 포트를 오픈할때 로그를 받는 서버에서 실행</p>
<pre><code class="language-bash">iptables -A INPUT  -p tcp -m tcp --sport 2203 -j ACCEPT
iptables -A OUTPUT - -p tcp -m tcp --dport 2203 -j ACCEPT
</code></pre>

<p>변경 규칙 저장</p>
<pre><code class="language-bash">/etc/init.d/iptables save
</code></pre>

<p>규칙삭제</p>
<pre><code class="language-bash">iptables -D INPUT 1 (몇번째 규칙 삭제)
</code></pre>

<p>규칙확인</p>
<pre><code class="language-bash">iptables -L -v
</code></pre>

<h3 id="prerouting--postrouting-설정-방법">PREROUTING / POSTROUTING 설정 방법</h3>

<p>PREROUTING은 패킷에서 목적지 IP를 변경하여 패킷을 특정 IP로 포워딩 할때 사용하며 내 자신의 PC에서 OUTPUT되는 패킷을 특정 PC 로 포워딩 하고 싶을때 사용한다.<br />
POSTROUTING은 패킷에서 보낸이 IP를 특정(사설/공인) IP로 변경하고 재전송한다.</p>

<p>먼저 FORWARDING 설정</p>
<pre><code class="language-bash">sysctl -w net.ipv4.ip_forward=1
sysctl -p /etc/sysctl.conf
</code></pre>

<p>아래 예제는 A서버에 APPLICATION이 운영되고 B서버에서 IPTABLES를 통해 포워딩이 이루어지고 불특정 다수의 사용자는 B서버를 통해 A서버로 접근할때 필요로 하는 설정으로
PREROUTING에서는 불특정 사용자가 B라는 서버에 접근할때 목적지 IP를 A서버로 변경하였고 POSTROUTING을 통해 나가는 패킷을 MASQUERAD (불특정 다수)하였다.</p>
<pre><code class="language-bash">iptables -A PREROUTING -t nat -p tcp  -d 호스트서버의아이피  --dport 포트번호 -j DNAT --to 포워딩내부아이피:포트번호
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</code></pre>

<p>정책 설정 FORWARD는 모드 ACCEPT</p>
<pre><code class="language-bash">iptables -A FORWARD -i ens1 -j ACCEPT
iptables -A FORWARD -o ens1 -j ACCEPT
</code></pre>

<p>-i en3로 인/아웃되고 목적지가 -d 192.168.0.93인 패킷을 192.168.0.57로 포워딩</p>
<pre><code class="language-bash">iptables -t nat -A PREROUTING -p tcp -i ens3 -d 192.168.0.93 -j DNAT --to 192.168.0.57
</code></pre>

<p>출발지가 -s destination.com인 패킷을 192.168.0.57로 포워딩</p>
<pre><code class="language-bash">iptables -t nat -s destination.com -A PREROUTING -p tcp -j DNAT --to 192.168.0.57
</code></pre>

<p>-o eth0로 나가는 패킷이 내부망에서 인터넷 외부로 전송될때 MASQUERADE 옵션 설정, MASQURADE는 사설 IP로 공인 IP로 변경하는 옵션</p>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</code></pre>

<h3 id="prerouting--postrouting-관련-명령어">PREROUTING / POSTROUTING 관련 명령어</h3>

<p>nat 테이블 등록</p>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 192.168.2.0/24 -o eth0 -j MASQUERADE
</code></pre>

<p>nat 리스트보기</p>
<pre><code class="language-bash">iptables -t nat -L -n
</code></pre>

<p>nat 테이블 모두 삭제</p>
<pre><code class="language-bash">iptables -t nat -F
</code></pre>

<p>nat 테이블 2번째 POSTROUTING 정책 삭제</p>
<pre><code class="language-bash">iptables -t nat -D POSTROUTING 2
</code></pre>

<p>iptables 저장</p>
<pre><code class="language-bash">service iptables save 
</code></pre>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <h3><i class="icon icon-comments-o"></i> Comments</h3>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://byunghoon82.github.io/blog/2019/linux-iptables/';
      this.page.identifier = '/blog/2019/linux-iptables';
    };
    (function() {
      var d = document,
      s = d.createElement('script');
      s.src = '//byunghoon.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</aside>


  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/byunghoon82" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="https://www.linkedin.com/in/byunghoon-park-60331170/" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2019 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


  <a href="https://github.com/byunghoon82/" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
</body>
</html>
